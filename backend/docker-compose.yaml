services:
    notenest-backend:
        build:
            context: .
        ports:
            - "8080:8080"
        environment:
            DSN: "postgres://notenest_user:notenest_user_password@notenest-db:5432/notenest_db?sslmode=disable"

        depends_on:
            notenest-db:
                condition: service_healthy
        networks:
            - notenest-backend-net

    migrate:
        image: migrate/migrate
        restart: no
        depends_on:
            notenest-db:
                condition: service_healthy
        networks:
            - notenest-backend-net
        volumes:
            - ./db/migrations:/db/migrations
        command:
            [
                "-path",
                "/db/migrations",
                "-database",
                "postgres://notenest_user:notenest_user_password@notenest-db:5432/notenest_db?sslmode=disable",
                "up",
            ]

    notenest-db:
        image: postgres:17.6-alpine
        environment:
            POSTGRES_USER: myuser
            POSTGRES_PASSWORD: mypassword
            POSTGRES_DB: mydb
        ports:
            - "5433:5432" #optional, for host access. use 5433 cause 5432 is used by local postgres
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U myuser -d mydb"]
            interval: 5s
            timeout: 3s
            retries: 5
        volumes:
            - ./db/init:/docker-entrypoint-initdb.d
            - pgdata:/var/lib/postgresql/data
        networks:
            - notenest-backend-net

volumes:
    pgdata:

networks:
    notenest-backend-net:
        driver: bridge
